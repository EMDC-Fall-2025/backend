name: Deploy Backend

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
  push:
    branches:
      - main
    # Uncomment to enable automatic deployment on push to main
    # paths:
    #   - 'emdcbackend/**'
    #   - 'requirements.txt'
    #   - 'Dockerfile'

jobs:
  test:
    name: Run Tests Before Deploy
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: emdc_test
          POSTGRES_USER: emdc_test
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./emdcbackend
        run: |
          python -m pip install --upgrade pip
          pip install -r ../requirements.txt

      - name: Run Django tests
        working-directory: ./emdcbackend
        env:
          POSTGRES_DB: emdc_test
          POSTGRES_USER: emdc_test
          POSTGRES_PASSWORD: test_password
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          DJANGO_SECRET_KEY: test-secret-key-for-ci-cd-pipeline-only
          DEBUG: 1
        run: |
          python manage.py test emdcbackend.test --verbosity=2

  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    needs: test
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Option 1: Deploy to DigitalOcean App Platform
      # - name: Deploy to DigitalOcean
      #   uses: digitalocean/app_action@main
      #   with:
      #     app_name: emdc-backend
      #     token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      # Option 2: Deploy via SSH to VPS with Docker
      # - name: Deploy via SSH
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ secrets.SSH_HOST }}
      #     username: ${{ secrets.SSH_USERNAME }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     port: ${{ secrets.SSH_PORT || 22 }}
      #     script: |
      #       cd /opt/emdc/backend
      #       git pull origin main
      #       docker-compose build django-api
      #       docker-compose up -d django-api
      #       docker-compose exec -T django-api python manage.py migrate
      #       docker-compose exec -T django-api python manage.py collectstatic --noinput

      # Option 3: Deploy to Heroku
      # - name: Deploy to Heroku
      #   uses: akhileshns/heroku-deploy@v3.12.14
      #   with:
      #     heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
      #     heroku_app_name: "emdc-backend"
      #     heroku_email: ${{ secrets.HEROKU_EMAIL }}
      #     appdir: "emdcbackend"

      # Option 4: Deploy to AWS ECS/Fargate
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: us-east-1

      # - name: Login to Amazon ECR
      #   id: login-ecr
      #   uses: aws-actions/amazon-ecr-login@v2

      # - name: Build, tag, and push image to Amazon ECR
      #   env:
      #     ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      #     ECR_REPOSITORY: emdc-backend
      #     IMAGE_TAG: ${{ github.sha }}
      #   run: |
      #     docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
      #     docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # - name: Deploy to ECS
      #   run: |
      #     aws ecs update-service --cluster emdc-cluster --service emdc-backend --force-new-deployment

      # Option 5: Deploy via Rsync
      # - name: Deploy via Rsync
      #   uses: burnett01/rsync-deployments@5.2
      #   with:
      #     switches: -avzr --delete
      #     path: ./emdcbackend/
      #     remote_path: /opt/emdc/backend/
      #     remote_host: ${{ secrets.SSH_HOST }}
      #     remote_user: ${{ secrets.SSH_USERNAME }}
      #     remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # - name: Run migrations and restart service
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ secrets.SSH_HOST }}
      #     username: ${{ secrets.SSH_USERNAME }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     script: |
      #       cd /opt/emdc/backend
      #       source venv/bin/activate
      #       pip install -r requirements.txt
      #       python manage.py migrate
      #       python manage.py collectstatic --noinput
      #       sudo systemctl restart emdc-backend

      - name: Deployment complete
        run: |
          echo "‚úÖ Deployment to ${{ github.event.inputs.environment || 'production' }} completed successfully!"
          echo "üîó API URL: ${{ secrets.API_URL }}"

  health-check:
    name: Post-deployment Health Check
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Check API health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.API_URL }}/api/health/ || echo "000")
          if [ "$response" = "200" ]; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ùå Health check failed with status code: $response"
            exit 1
          fi
        continue-on-error: true

